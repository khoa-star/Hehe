name: AnhKhoaDesktop

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'üïê Th·ªùi gian s·ª≠ d·ª•ng'
        required: false
        default: '5h40m'
        type: choice
        options:
        - '1h'
        - '3h'
        - '5h40m'
      windows_version:
        description: 'üñ• Ch·ªçn Windows Server'
        required: false
        default: '2022'
        type: choice
        options:
        - '2019'
        - '2022'
        - 'latest'

jobs:
  Premium-RDP-Setup:
    runs-on: windows-2022
    timeout-minutes: 340
    steps:
      - name: üéØ KH·ªûI ƒê·ªòNG H·ªÜ TH·ªêNG
        run: |
          Write-Host "`nü§ñ AnhKhoaDesktop RDP SERVER" -ForegroundColor Yellow
          Write-Host "‚ö° Powered by AI STV" -ForegroundColor Green
          Write-Host "üïí Th·ªùi gian: ${GITHUB_EVENT_INPUTS_DURATION:-5h40m}" -ForegroundColor Magenta
          # Loading effect
          $frames = @('‚£æ','‚£Ω','‚£ª','‚¢ø','‚°ø','‚£ü','‚£Ø','‚£∑')
          for($i=0;$i -lt 10;$i++){
            Write-Host "`rüöÄ ƒêang kh·ªüi t·∫°o h·ªá th·ªëng... $($frames[$i % 8])" -NoNewline -ForegroundColor Blue
            Start-Sleep -Milliseconds 100
          }
          Write-Host "`r‚úÖ H·ªá th·ªëng ƒë√£ s·∫µn s√†ng!" -ForegroundColor Green

      - name: üîß C·∫§U H√åNH H·ªÜ TH·ªêNG
        run: |
          Write-Host "`nüõ†Ô∏è ƒêANG C·∫§U H√åNH H·ªÜ TH·ªêNG" -ForegroundColor Yellow
          # T·∫Øt firewall/antivirus
          Set-MpPreference -DisableRealtimeMonitoring $true -ErrorAction SilentlyContinue
          Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False -ErrorAction SilentlyContinue
          # B·∫≠t RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
          netsh advfirewall firewall add rule name="RDP-Premium" dir=in action=allow protocol=TCP localport=3389
          netsh advfirewall firewall add rule name="RDP-Premium-Out" dir=out action=allow protocol=TCP localport=3389
          Set-Service -Name TermService -StartupType Automatic -ErrorAction SilentlyContinue
          Start-Service -Name TermService -ErrorAction SilentlyContinue

      - name: üë§ T·∫†O T√ÄI KHO·∫¢N PREMIUM
        run: |
          Write-Host "`nüë§ ƒêANG T·∫†O T√ÄI KHO·∫¢N PREMIUM" -ForegroundColor Yellow
          $matKhau = "AnhKhoa@123"
          $securePass = ConvertTo-SecureString $matKhau -AsPlainText -Force
          try { Remove-LocalUser -Name "AnhKhoaVipPro" -ErrorAction SilentlyContinue } catch {}
          New-LocalUser -Name "AnhKhoaVipPro" -Password $securePass -AccountNeverExpires -Description "AnhKhoa Desktop Premium"
          Set-LocalUser -Name "AnhKhoaVipPro" -PasswordNeverExpires $true -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Administrators" -Member "AnhKhoaVipPro" -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "AnhKhoaVipPro" -ErrorAction SilentlyContinue
          Enable-LocalUser -Name "AnhKhoaVipPro"
          Write-Host "‚úÖ T√†i kho·∫£n AnhKhoaVipPro ƒë√£ s·∫µn s√†ng" -ForegroundColor Green
          echo "RDP_USER=AnhKhoaVipPro" >> $env:GITHUB_ENV
          echo "RDP_PASS=$matKhau" >> $env:GITHUB_ENV
          Write-Host "User: ________"
          Write-Host "Pass: ________"

      - name: üóÇ C√ÄI WINRAR
        run: |
          Write-Host "`nüîÑ Ki·ªÉm tra WinRAR" -ForegroundColor Yellow
          $winrarPath = "$env:ProgramFiles\WinRAR\WinRAR.exe"
          if (-Not (Test-Path $winrarPath)) {
            Write-Host "WinRAR ch∆∞a c√†i, ƒëang t·∫£i..." -ForegroundColor Blue
            $exePath = "$env:TEMP\winrar-installer.exe"
            try {
              Invoke-WebRequest -Uri "https://www.win-rar.com/fileadmin/winrar-versions/winrar/winrar-x64-713.exe" -OutFile $exePath -UseBasicParsing
              Start-Process -FilePath $exePath -ArgumentList "/S" -Wait -ErrorAction Stop
              Write-Host "‚úÖ WinRAR ƒë√£ c√†i xong" -ForegroundColor Green
            } catch {
              Write-Host "‚ö†Ô∏è Kh√¥ng c√†i ƒë∆∞·ª£c WinRAR, b·ªè qua" -ForegroundColor Yellow
            }
          } else {
            Write-Host "‚úÖ WinRAR ƒë√£ t·ªìn t·∫°i" -ForegroundColor Green
          }

      - name: üåê THI·∫æT L·∫¨P TAILSCALE
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          Write-Host "`nüåê ƒêANG THI·∫æT L·∫¨P TAILSCALE" -ForegroundColor Yellow
          $msiPath = "$env:TEMP\tailscale-premium.msi"
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile $msiPath -UseBasicParsing
          Start-Process msiexec.exe -ArgumentList "/i", "`"$msiPath`"", "/quiet", "/norestart" -Wait
          Remove-Item $msiPath -Force
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$env:TAILSCALE_AUTH_KEY --hostname=anhkhoa-desktop --accept-routes --accept-dns --reset
          Write-Host "‚úÖ Tailscale OK" -ForegroundColor Green
          # Hi·ªÉn th·ªã IP
          $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
          if ($ip) {
            echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
            Write-Host "IP: ________"
          } else {
            echo "TAILSCALE_IP=localhost" >> $env:GITHUB_ENV
            Write-Host "IP: ________"
          }

      - name: ‚è≥ DUY TR√å PHI√äN L√ÄM VI·ªÜC
        run: |
          $durationInput = "${{ github.event.inputs.duration }}"
          switch ($durationInput) {
            "1h" { $totalMinutes = 60 }
            "3h" { $totalMinutes = 180 }
            "5h40m" { $totalMinutes = 340 }
            default { $totalMinutes = 60 }
          }
          $timeZone = [System.TimeZoneInfo]::FindSystemTimeZoneById("SE Asia Standard Time")
          $thoiGianBatDau = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $timeZone)
          $thoiGianKetThuc = $thoiGianBatDau.AddMinutes($totalMinutes)

          $monitorScript = {
            while($true){
              $termService = Get-Service -Name TermService -ErrorAction SilentlyContinue
              if ($termService.Status -ne 'Running'){ Start-Service TermService -ErrorAction SilentlyContinue }
              Start-Sleep -Seconds 30
            }
          }
          Start-Job -ScriptBlock $monitorScript -Name "SystemMonitor"

          Write-Host "üéØ Phi√™n l√†m vi·ªác ƒëang duy tr√¨... B·∫Øt ƒë·∫ßu: $($thoiGianBatDau) - K·∫øt th√∫c: $($thoiGianKetThuc)"

      - name: üßπ D·ªåN D·∫∏P H·ªÜ TH·ªêNG
        if: always()
        run: |
          Write-Host "`nüßπ ƒêANG D·ªåN D·∫∏P H·ªÜ TH·ªêNG..." -ForegroundColor Yellow
          try { Remove-Item "$env:TEMP\winrar-installer.exe" -ErrorAction SilentlyContinue } catch {}
          try { Disable-LocalUser -Name "AnhKhoaVipPro" -ErrorAction SilentlyContinue } catch {}
          try { netsh advfirewall firewall delete rule name="RDP-Premium" dir=in } catch {}
          try { netsh advfirewall firewall delete rule name="RDP-Premium-Out" dir=out } catch {}
          Write-Host "üéâ D·ªçn d·∫πp ho√†n t·∫•t!" -ForegroundColor Green
