name: AnhKhoaDesktop

on:
  workflow_dispatch:
    inputs:
      os:
        description: "Chá»n Windows Server"
        required: true
        default: windows-2022
        type: choice
        options:
          - windows-2019
          - windows-2022
          - windows-latest
      duration:
        description: "Thá»i gian cháº¡y"
        required: true
        default: "6h"
        type: choice
        options:
          - "6h"
          - "12h"

jobs:
  rdp:
    runs-on: ${{ github.event.inputs.os }}
    timeout-minutes: 720

    steps:
    - name: ğŸ› ï¸ ÄANG Cáº¤U HÃŒNH Há»† THá»NG
      shell: powershell
      run: |
        Write-Host "`nğŸ› ï¸ ÄANG Cáº¤U HÃŒNH Há»† THá»NG" -ForegroundColor Yellow

    - name: ğŸ‘¤ Táº O USER PREMIUM
      shell: powershell
      run: |
        $username = "AnhKhoaVipPro"
        $password = "AnhKhoa@123"

        net user $username $password /add /y
        net localgroup administrators $username /add
        net localgroup "Remote Desktop Users" $username /add

    - name: ğŸ“¦ CÃ€I WINRAR (Lá»–I THÃŒ Bá» QUA)
      shell: powershell
      run: |
        $url = "https://www.win-rar.com/fileadmin/winrar-versions/winrar/winrar-x64-713.exe"
        $exe = "$env:TEMP\winrar.exe"
        try {
          Invoke-WebRequest $url -OutFile $exe -UseBasicParsing
          Start-Process $exe -ArgumentList "/S" -Wait
        } catch {
          Write-Host "âš ï¸ CÃ i WinRAR tháº¥t báº¡i - bá» qua"
        }

    - name: ğŸ›¡ï¸ Táº®T ANTIVIRUS & FIREWALL
      shell: powershell
      run: |
        Set-MpPreference -DisableRealtimeMonitoring $true
        Set-MpPreference -DisableBehaviorMonitoring $true
        Set-MpPreference -DisableBlockAtFirstSeen $true
        Set-MpPreference -DisableIOAVProtection $true
        Set-MpPreference -DisablePrivacyMode $true
        Set-MpPreference -DisableScriptScanning $true

        netsh advfirewall set allprofiles state off
        reg add "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer" /v SmartScreenEnabled /t REG_SZ /d Off /f

    - name: ğŸ” Báº¬T RDP
      shell: powershell
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Start-Service TermService

    - name: ğŸŒ CÃ€I & Káº¾T Ná»I TAILSCALE
      shell: powershell
      env:
        TSKEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      run: |
        Invoke-WebRequest https://pkgs.tailscale.com/stable/tailscale-setup.exe -OutFile tailscale.exe
        Start-Process tailscale.exe -ArgumentList "/S" -Wait
        & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=$env:TSKEY --accept-risk=all

    - name: ğŸ“‹ HIá»‚N THá»Š THÃ”NG TIN RDP
      shell: powershell
      run: |
        $ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
        $user = "AnhKhoaVipPro"
        $pass = "AnhKhoa@123"

        Write-Host ""
        Write-Host "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
        Write-Host "â”‚ ğŸŒ IP   : $ip"
        Write-Host "â”‚ ğŸ‘¤ USER : $user"
        Write-Host "â”‚ ğŸ” PASS : $pass"
        Write-Host "â”‚ ğŸ–¥ï¸ PORT : 3389"
        Write-Host "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
        Write-Host ""

    - name: â±ï¸ DUY TRÃŒ PHIÃŠN (KEEP ALIVE)
      shell: powershell
      run: |
        if ("${{ github.event.inputs.duration }}" -eq "6h") {
          $seconds = 21600
        } else {
          $seconds = 43200
        }

        $end = (Get-Date).AddSeconds($seconds)

        while ((Get-Date) -lt $end) {
          $svc = Get-Service TermService
          if ($svc.Status -ne "Running") {
            Start-Service TermService
          }
          Start-Sleep -Seconds 30
        }

        Write-Host "â›” Háº¾T THá»œI GIAN - Káº¾T THÃšC"
