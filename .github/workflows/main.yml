name: AnhKhoaDesktop

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'ğŸ• Thá»i gian sá»­ dá»¥ng'
        required: false
        default: '5h40m'
        type: choice
        options:
        - '1h'
        - '3h'
        - '5h40m'
      server_version:
        description: 'Chá»n Windows Server'
        required: false
        default: '2022'
        type: choice
        options:
        - '2019'
        - '2022'
        - 'latest'

jobs:
  Premium-RDP-Setup:
    runs-on: windows-2022
    timeout-minutes: 340

    steps:
    # BANNER CHÃ€O Má»ªNG
    - name: ğŸ¯ KHá»I Äá»˜NG Há»† THá»NG
      run: |
        Write-Host ""
        Write-Host ""
        Write-Host "ğŸ¤– AI STV PREMIUM RDP SERVER" -ForegroundColor Yellow
        Write-Host "âš¡ Powered by AI STV" -ForegroundColor Green
        Write-Host "ğŸ•’ Thá»i gian: ${{ github.event.inputs.duration }}" -ForegroundColor Magenta
        Write-Host ""

        $frames = @('â£¾','â£½','â£»','â¢¿','â¡¿','â£Ÿ','â£¯','â£·')
        for($i=0;$i -lt 10;$i++) {
          Write-Host "`rğŸš€ Äang khá»Ÿi táº¡o há»‡ thá»‘ng... $($frames[$i % 8])" -NoNewline -ForegroundColor Blue
          Start-Sleep -Milliseconds 100
        }
        Write-Host "`râœ… Há»‡ thá»‘ng Ä‘Ã£ sáºµn sÃ ng!" -ForegroundColor Green

    # Cáº¤U HÃŒNH Há»† THá»NG (giá»‘ng Windows Server 2012)
    - name: ğŸ”§ Cáº¤U HÃŒNH Há»† THá»NG
      run: |
        Write-Host "`nğŸ› ï¸ ÄANG Cáº¤U HÃŒNH Há»† THá»NG" -ForegroundColor Yellow

        # Báº­t RDP
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force

        # Táº¯t xÃ¡c thá»±c máº¡ng
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force

        # Cáº¥u hÃ¬nh báº£o máº­t RDP
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force

        # Má»Ÿ port 3389 firewall
        netsh advfirewall firewall add rule name="RDP-Premium" dir=in action=allow protocol=TCP localport=3389 profile=any
        netsh advfirewall firewall add rule name="RDP-Premium-Out" dir=out action=allow protocol=TCP localport=3389 profile=any

        # Táº¯t háº¿t Antivirus / Windows Defender / SmartScreen / App & Browser
        Set-MpPreference -DisableRealtimeMonitoring $true -ErrorAction SilentlyContinue
        Set-MpPreference -DisableBehaviorMonitoring $true -ErrorAction SilentlyContinue
        Set-MpPreference -DisableIOAVProtection $true -ErrorAction SilentlyContinue
        Set-MpPreference -DisablePrivacyMode $true -ErrorAction SilentlyContinue
        Set-MpPreference -DisableScriptScanning $true -ErrorAction SilentlyContinue
        Set-MpPreference -DisableIntrusionPreventionSystem $true -ErrorAction SilentlyContinue
        Set-MpPreference -DisableArchiveScanning $true -ErrorAction SilentlyContinue

        # Khá»Ÿi Ä‘á»™ng dá»‹ch vá»¥ RDP
        Set-Service -Name TermService -StartupType Automatic -ErrorAction SilentlyContinue
        Set-Service -Name UmRdpService -StartupType Automatic -ErrorAction SilentlyContinue
        Start-Service -Name TermService -ErrorAction SilentlyContinue
        Start-Service -Name UmRdpService -ErrorAction SilentlyContinue

    # Táº O USER PREMIUM
    - name: ğŸ‘¤ Táº O TÃ€I KHOáº¢N PREMIUM
      run: |
        Write-Host "`nğŸ‘¤ ÄANG Táº O TÃ€I KHOáº¢N PREMIUM" -ForegroundColor Yellow

        $matKhau = "AnhKhoa@123"
        $securePass = ConvertTo-SecureString $matKhau -AsPlainText -Force

        try {
          Remove-LocalUser -Name "AnhKhoaVipPro" -ErrorAction SilentlyContinue
        } catch {}

        New-LocalUser -Name "AnhKhoaVipPro" -Password $securePass -AccountNeverExpires -Description "AI STV Premium Account"
        Set-LocalUser -Name "AnhKhoaVipPro" -PasswordNeverExpires $true -ErrorAction SilentlyContinue
        Add-LocalGroupMember -Group "Administrators" -Member "AnhKhoaVipPro" -ErrorAction SilentlyContinue
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member "AnhKhoaVipPro" -ErrorAction SilentlyContinue
        Add-LocalGroupMember -Group "Users" -Member "AnhKhoaVipPro" -ErrorAction SilentlyContinue
        Enable-LocalUser -Name "AnhKhoaVipPro"

        # LÆ°u user/password
        echo "RDP_USER=AnhKhoaVipPro" >> $env:GITHUB_ENV
        echo "RDP_PASS=$matKhau" >> $env:GITHUB_ENV

    # CÃ€I WINRAR
    - name: ğŸ“¦ CÃ€I WINRAR
      run: |
        Write-Host "`nğŸ”„ Kiá»ƒm tra WinRAR..."
        $winrarUrl = "https://www.win-rar.com/fileadmin/winrar-versions/winrar/winrar-x64-713.exe"
        $exePath = "$env:TEMP\winrar-installer.exe"
        try {
          Invoke-WebRequest -Uri $winrarUrl -OutFile $exePath -UseBasicParsing
          Start-Process -FilePath $exePath -ArgumentList "/S" -Wait
        } catch {
          Write-Host "âš ï¸ KhÃ´ng thá»ƒ cÃ i WinRAR, bá» qua..." -ForegroundColor Yellow
        }

    # TAILSCALE
    - name: ğŸŒ CÃ€I Äáº¶T VÃ€ Káº¾T Ná»I TAILSCALE
      env:
        TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      run: |
        Write-Host "`nğŸŒ ÄANG CÃ€I TAILSCALE..." -ForegroundColor Yellow
        $msiPath = "$env:TEMP\tailscale-premium.msi"
        Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile $msiPath
        Start-Process msiexec.exe -ArgumentList "/i", "`"$msiPath`"", "/quiet", "/norestart" -Wait
        Remove-Item $msiPath -Force

        # Káº¿t ná»‘i Tailscale
        & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$env:TAILSCALE_AUTH_KEY --hostname=AnhKhoaDesktop-$env:GITHUB_RUN_ID --accept-routes --accept-dns --reset

        # Láº¥y IP
        $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
        echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV

    # HIá»‚N THá»Š THÃ”NG TIN
    - name: ğŸ‰ THÃ”NG TIN Káº¾T Ná»I
      run: |
        Write-Host ""
        Write-Host "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
        Write-Host "â”‚ ğŸŒ IP: ________ â”‚"
        Write-Host "â”‚ ğŸ‘¤ User: ________ â”‚"
        Write-Host "â”‚ ğŸ” Pass: ________ â”‚"
        Write-Host "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"

    # DUY TRÃŒ PHIÃŠN
    - name: â³ DUY TRÃŒ PHIÃŠN
      run: |
        Write-Host "`nğŸ”„ Báº®T Äáº¦U DUY TRÃŒ PHIÃŠN LÃ€M VIá»†C..."
        while ($true) {
          $termService = Get-Service -Name TermService -ErrorAction SilentlyContinue
          if ($termService.Status -ne 'Running') { Start-Service -Name TermService -ErrorAction SilentlyContinue }
          Start-Sleep -Seconds 30
        }
