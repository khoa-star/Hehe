name: AnhKhoaDesktop
on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'ğŸ• Thá»i gian sá»­ dá»¥ng'
        required: false
        default: '6h'
        type: choice
        options:
        - '1h'
        - '3h'
        - '6h'
      server:
        description: 'Chá»n server'
        required: false
        default: '2022'
        type: choice
        options:
        - '2019'
        - '2022'
        - 'latest'

jobs:
  Premium-RDP-Setup:
    runs-on: windows-2022
    timeout-minutes: 360
    steps:
      - name: ğŸ¯ KHá»I Äá»˜NG Há»† THá»NG
        run: |
          Write-Host "`nğŸ¤– AnhKhoa Desktop RDP Server" -ForegroundColor Yellow
          Write-Host "âš¡ Powered by AnhKhoaVipPro" -ForegroundColor Green
          Write-Host "ğŸ•’ Thá»i gian: ${{ github.event.inputs.duration }}" -ForegroundColor Magenta

      - name: ğŸ”§ Cáº¤U HÃŒNH Há»† THá»NG
        run: |
          Write-Host "`nğŸ› ï¸ ÄANG Cáº¤U HÃŒNH Há»† THá»NG" -ForegroundColor Yellow
          # Báº­t Remote Desktop
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          # Táº¯t xÃ¡c thá»±c máº¡ng cho RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          # Cáº¥u hÃ¬nh báº£o máº­t RDP giá»‘ng 2012
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
          # Má»Ÿ port 3389 firewall
          netsh advfirewall firewall add rule name="RDP-Premium" dir=in action=allow protocol=TCP localport=3389 profile=any
          netsh advfirewall firewall add rule name="RDP-Premium-Out" dir=out action=allow protocol=TCP localport=3389 profile=any
          # Táº¯t háº¿t antivirus, firewall, SmartScreen
          Set-MpPreference -DisableRealtimeMonitoring $true -ErrorAction SilentlyContinue
          Set-MpPreference -DisableBehaviorMonitoring $true -ErrorAction SilentlyContinue
          Set-MpPreference -DisableIOAVProtection $true -ErrorAction SilentlyContinue
          Set-MpPreference -DisableIntrusionPreventionSystem $true -ErrorAction SilentlyContinue
          Set-MpPreference -DisableScriptScanning $true -ErrorAction SilentlyContinue
          Set-ExecutionPolicy Unrestricted -Force
          Set-MpPreference -ExclusionPath "C:\Program Files","C:\Program Files (x86)","C:\Users" -ErrorAction SilentlyContinue
          Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" -Name "EnableLUA" -Value 0 -Force
          Stop-Service -Name "WinDefend" -Force -ErrorAction SilentlyContinue
          Stop-Service -Name "wuauserv" -Force -ErrorAction SilentlyContinue
          Stop-Service -Name "MpsSvc" -Force -ErrorAction SilentlyContinue
          Start-Service -Name TermService -ErrorAction SilentlyContinue
          Start-Service -Name UmRdpService -ErrorAction SilentlyContinue

      - name: ğŸ‘¤ Táº O TÃ€I KHOáº¢N PREMIUM
        run: |
          Write-Host "`nğŸ‘¤ ÄANG Táº O TÃ€I KHOáº¢N PREMIUM" -ForegroundColor Yellow
          $UserName = "AnhKhoaVipPro"
          $Password = "AnhKhoa@123" 
          $SecurePass = ConvertTo-SecureString $Password -AsPlainText -Force
          # XÃ³a user cÅ© náº¿u cÃ³
          Remove-LocalUser -Name $UserName -ErrorAction SilentlyContinue
          # Táº¡o user má»›i
          New-LocalUser -Name $UserName -Password $SecurePass -AccountNeverExpires -Description "AnhKhoaVipPro Account"
          # ThÃªm quyá»n
          Add-LocalGroupMember -Group "Administrators" -Member $UserName
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $UserName
          Enable-LocalUser -Name $UserName
          Write-Host "`nâœ… TÃ i khoáº£n $UserName Ä‘Ã£ sáºµn sÃ ng" -ForegroundColor Green
          echo "RDP_USER=$UserName" >> $env:GITHUB_ENV
          echo "RDP_PASS=$Password" >> $env:GITHUB_ENV

      - name: ğŸŒ CÃ€I TAILSCALE PREMIUM
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          Write-Host "`nğŸŒ ÄANG CÃ€I TAILSCALE" -ForegroundColor Yellow
          $msiPath = "$env:TEMP\tailscale-premium.msi"
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile $msiPath
          Start-Process msiexec.exe -ArgumentList "/i `"$msiPath`" /quiet /norestart" -Wait
          Remove-Item $msiPath -Force
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$env:TAILSCALE_AUTH_KEY --hostname=AnhKhoaDesktop-$env:GITHUB_RUN_ID --accept-routes --accept-dns --reset
          $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
          echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV

      - name: ğŸ—‚ï¸ CÃ€I WINRAR (Bá» QUA Náº¾U Lá»–I)
        run: |
          Write-Host "`nğŸ”„ Äang cÃ i WinRAR" -ForegroundColor Yellow
          $exePath = "$env:TEMP\winrar-x64-713.exe"
          try {
            Invoke-WebRequest -Uri "https://www.win-rar.com/fileadmin/winrar-versions/winrar/winrar-x64-713.exe" -OutFile $exePath
            Start-Process -FilePath $exePath -ArgumentList "/S" -Wait
            Remove-Item $exePath -Force
            Write-Host "âœ… CÃ i WinRAR xong" -ForegroundColor Green
          } catch {
            Write-Host "âš ï¸ CÃ i WinRAR khÃ´ng thÃ nh cÃ´ng, bá» qua" -ForegroundColor Yellow
          }

      - name: ğŸ” HIá»‚N THá»Š THÃ”NG TIN Káº¾T Ná»I
        run: |
          $UserName = $env:RDP_USER
          $Password = $env:RDP_PASS
          $IP = $env:TAILSCALE_IP
          Write-Host "`nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”" -ForegroundColor Cyan
          Write-Host "â”‚ ğŸŒ IP: $IP" -ForegroundColor White
          Write-Host "â”‚ ğŸ‘¤ User: $UserName" -ForegroundColor White
          Write-Host "â”‚ ğŸ” Pass: $Password" -ForegroundColor White
          Write-Host "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜" -ForegroundColor Cyan

      - name: â³ DUY TRÃŒ PHIÃŠN LÃ€M VIá»†C
        run: |
          Write-Host "`nğŸ”„ Báº®T Äáº¦U DUY TRÃŒ PHIÃŠN LÃ€M VIá»†C..." -ForegroundColor Yellow
          $totalMinutes = 360
          $timeZone = [System.TimeZoneInfo]::FindSystemTimeZoneById("SE Asia Standard Time")
          $startTime = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $timeZone)
          $endTime = $startTime.AddMinutes($totalMinutes)
          $frames = @('â ‹','â ™','â ¹','â ¸','â ¼','â ´','â ¦','â §','â ‡','â ')
          do {
            $now = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $timeZone)
            $remaining = $endTime - $now
            $h = [math]::Max(0,[math]::Floor($remaining.TotalHours))
            $m = [math]::Max(0,[math]::Floor($remaining.TotalMinutes % 60))
            $s = [math]::Max(0,[math]::Floor($remaining.TotalSeconds % 60))
            $frame = $frames[([int]((Get-Date) - $startTime).TotalSeconds) % $frames.Length]
            Write-Host "`r$frame Thá»i gian cÃ²n láº¡i: $h giá» $m phÃºt $s giÃ¢y" -NoNewline -ForegroundColor Green
            Start-Sleep -Seconds 5
          } while ($remaining.TotalSeconds -gt 0)
          Write-Host "`nğŸ¯ Háº¾T THá»œI GIAN - Tá»° Äá»˜NG Dá»ªNG!" -ForegroundColor Red
