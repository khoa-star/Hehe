name: AnhKhoaDesktop

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'ğŸ• Thá»i gian cháº¡y'
        required: true
        default: '6h'
        type: choice
        options:
          - '6h'
          - '12h'

jobs:
  RDP:
    runs-on: windows-2022
    timeout-minutes: 720

    steps:
    - name: ğŸ¯ KHá»I Äá»˜NG
      run: |
        Write-Host ""
        Write-Host "ğŸš€ AnhKhoaDesktop - Windows Server 2022" -ForegroundColor Cyan
        Write-Host "â± Duration: ${{ github.event.inputs.duration }}" -ForegroundColor Yellow
        Write-Host ""

    # =========================
    # Cáº¤U HÃŒNH Há»† THá»NG (RDP ONLY)
    # =========================
    - name: ğŸ› ï¸ Cáº¤U HÃŒNH Há»† THá»NG
      run: |
        Write-Host "`nğŸ› ï¸ ÄANG Cáº¤U HÃŒNH Há»† THá»NG" -ForegroundColor Yellow

        Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
          -Name fDenyTSConnections -Value 0 -Force

        Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
          -Name UserAuthentication -Value 0 -Force

        Set-Service TermService -StartupType Automatic
        Start-Service TermService

        Write-Host "âœ… RDP OK" -ForegroundColor Green

    # =========================
    # Táº®T FIREWALL + DEFENDER (BÆ¯á»šC RIÃŠNG â€“ KHÃ”NG Gá»˜P)
    # =========================
    - name: ğŸ”¥ Táº®T FIREWALL & ANTIVIRUS
      run: |
        Write-Host "`nğŸ”¥ ÄANG Táº®T FIREWALL / DEFENDER" -ForegroundColor Yellow

        try {
          Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False
        } catch {}

        try {
          Set-MpPreference -DisableRealtimeMonitoring $true
          Set-MpPreference -DisableBehaviorMonitoring $true
          Set-MpPreference -DisableIOAVProtection $true
        } catch {}

        Write-Host "âš ï¸ ÄÃƒ Táº®T (Náº¾U CÃ“ THá»‚)" -ForegroundColor Green

    # =========================
    # Táº O USER PREMIUM
    # =========================
    - name: ğŸ‘¤ Táº O USER PREMIUM
      run: |
        $user = "AnhKhoaVipPro"
        $pass = "AnhKhoa@123"
        $secure = ConvertTo-SecureString $pass -AsPlainText -Force

        Remove-LocalUser -Name $user -ErrorAction SilentlyContinue

        New-LocalUser $user -Password $secure -AccountNeverExpires
        Add-LocalGroupMember Administrators $user
        Add-LocalGroupMember "Remote Desktop Users" $user

        echo "RDP_USER=$user" >> $env:GITHUB_ENV
        echo "RDP_PASS=$pass" >> $env:GITHUB_ENV

        Write-Host "âœ… USER Táº O XONG" -ForegroundColor Green

    # =========================
    # CÃ€I WINRAR (FAIL â†’ Bá» QUA)
    # =========================
    - name: ğŸ“¦ CÃ€I WINRAR
      run: |
        Write-Host "`nğŸ“¦ CÃ€I WINRAR" -ForegroundColor Yellow
        $url = "https://www.win-rar.com/fileadmin/winrar-versions/winrar/winrar-x64-713.exe"
        $exe = "$env:TEMP\winrar.exe"

        try {
          Invoke-WebRequest $url -OutFile $exe -UseBasicParsing
          Start-Process $exe -ArgumentList "/S" -Wait
          Write-Host "âœ… WINRAR OK" -ForegroundColor Green
        } catch {
          Write-Host "âš ï¸ WINRAR FAIL â†’ Bá» QUA" -ForegroundColor Yellow
        }

    # =========================
    # TAILSCALE (CHá»ˆ BÆ¯á»šC NÃ€Y Cáº¦N SECRET)
    # =========================
    - name: ğŸŒ TAILSCALE
      env:
        TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      run: |
        Invoke-WebRequest https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi `
          -OutFile tailscale.msi
        Start-Process msiexec.exe -ArgumentList "/i tailscale.msi /quiet" -Wait

        & "C:\Program Files\Tailscale\tailscale.exe" up `
          --authkey=$env:TAILSCALE_AUTH_KEY `
          --hostname=AnhKhoaDesktop

        $ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
        echo "TS_IP=$ip" >> $env:GITHUB_ENV

    # =========================
    # HIá»‚N THá»Š THÃ”NG TIN â€“ KHUNG CHUáº¨N
    # =========================
    - name: ğŸ‰ THÃ”NG TIN Káº¾T Ná»I
      run: |
        Write-Host ""
        Write-Host "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”" -ForegroundColor Cyan
        Write-Host "â”‚ ğŸŒ IP   : $env:TS_IP" -ForegroundColor White
        Write-Host "â”‚ ğŸ‘¤ USER : $env:RDP_USER" -ForegroundColor White
        Write-Host "â”‚ ğŸ” PASS : $env:RDP_PASS" -ForegroundColor White
        Write-Host "â”‚ ğŸ“ PORT : 3389" -ForegroundColor White
        Write-Host "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜" -ForegroundColor Cyan

    # =========================
    # DUY TRÃŒ PHIÃŠN (JOB CÅ¨ GIá»® NGUYÃŠN)
    # =========================
    - name: â³ DUY TRÃŒ PHIÃŠN
      run: |
        $hours = if ("${{ github.event.inputs.duration }}" -eq "12h") {12} else {6}
        $end = (Get-Date).AddHours($hours)

        while ((Get-Date) -lt $end) {
          Write-Host "ğŸ•’ ÄANG CHáº Y... $(Get-Date)"
          Start-Sleep 300
        }

    # =========================
    # Dá»ŒN Dáº¸P (JOB CÅ¨ â€“ KHÃ”NG Bá»)
    # =========================
    - name: ğŸ§¹ Dá»ŒN Dáº¸P
      if: always()
      run: |
        Stop-Service TermService -Force
        Write-Host "ğŸ‘‹ Káº¾T THÃšC"
